<div class="container mt-5">
  <h2>Mi Perfil</h2>
  <div *ngIf="loading" class="alert alert-info">Cargando...</div>
  <div *ngIf="!loading && usuario.id; else noAutenticado">
    <div class="card">
      <div class="card-body">
        <div class="text-center mb-3">
          <img *ngIf="usuario.foto" [src]="'http://localhost:8000' + usuario.foto" alt="Foto de perfil" class="rounded-circle" style="max-width: 150px;">
          <p *ngIf="!usuario.foto" class="text-muted">Sin foto de perfil</p>
        </div>
        <div *ngIf="!editMode; else editForm">
          <h5 class="card-title">Bienvenido, {{ usuario.nombre }} {{ usuario.apellidos || '' }}</h5>
          <p class="card-text"><strong>Email:</strong> {{ usuario.email }}</p>
          <p class="card-text"><strong>Teléfono:</strong> {{ usuario.telefono || 'No especificado' }}</p>
          <p class="card-text"><strong>Dirección:</strong> {{ usuario.direccion || 'No especificada' }}</p>
          <p class="card-text"><strong>Cuenta activa:</strong> {{ usuario.activo ? 'Sí' : 'No' }}</p>
          <button class="btn btn-primary" (click)="toggleEditMode()">Editar Perfil</button>
        </div>
        <ng-template #editForm>
          <form (ngSubmit)="guardarCambios()">
            <div class="mb-3">
              <label for="foto" class="form-label">Foto de perfil</label>
              <input type="file" class="form-control" id="foto" (change)="onFileSelected($event)" accept="image/*">
            </div>
            <div class="mb-3">
              <label for="nombre" class="form-label">Nombre *</label>
              <input type="text" class="form-control" id="nombre" [(ngModel)]="usuario.nombre" name="nombre" required>
            </div>
            <div class="mb-3">
              <label for="apellidos" class="form-label">Apellidos</label>
              <input type="text" class="form-control" id="apellidos" [(ngModel)]="usuario.apellidos" name="apellidos">
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Email *</label>
              <input type="email" class="form-control" id="email" [(ngModel)]="usuario.email" name="email" required disabled>
              <small class="form-text text-muted">El email no se puede modificar.</small>
            </div>
            <div class="mb-3">
              <label for="telefono" class="form-label">Teléfono</label>
              <input type="tel" class="form-control" id="telefono" [(ngModel)]="usuario.telefono" name="telefono" pattern="[0-9]{9}">
              <small class="form-text text-danger" *ngIf="usuario.telefono && !usuario.telefono.match('[0-9]{9}')">El teléfono debe tener 9 dígitos.</small>
            </div>
            <div class="mb-3">
              <label for="direccion" class="form-label">Dirección</label>
              <textarea class="form-control" id="direccion" [(ngModel)]="usuario.direccion" name="direccion" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-success me-2">Guardar</button>
            <button type="button" class="btn btn-secondary" (click)="toggleEditMode()">Cancelar</button>
          </form>
          <hr>
          <h5>Cambiar Contraseña</h5>
          <form (ngSubmit)="cambiarContrasena()">
            <div class="mb-3">
              <label for="currentPassword" class="form-label">Contraseña actual</label>
              <input type="password" class="form-control" id="currentPassword" [(ngModel)]="passwordData.currentPassword" name="currentPassword" required>
            </div>
            <div class="mb-3">
              <label for="newPassword" class="form-label">Nueva contraseña</label>
              <input type="password" class="form-control" id="newPassword" [(ngModel)]="passwordData.newPassword" name="newPassword" required>
            </div>
            <div class="mb-3">
              <label for="confirmPassword" class="form-label">Confirmar nueva contraseña</label>
              <input type="password" class="form-control" id="confirmPassword" [(ngModel)]="passwordData.confirmPassword" name="confirmPassword" required>
            </div>
            <button type="submit" class="btn btn-warning">Cambiar Contraseña</button>
            <div class="alert alert-danger mt-3" *ngIf="passwordError">{{ passwordError }}</div>
          </form>
        </ng-template>
      </div>
    </div>
  </div>
  <ng-template #noAutenticado>
    <div class="alert alert-warning">Por favor, inicia sesión para ver tu perfil.</div>
  </ng-template>
  <div class="alert alert-success mt-3" *ngIf="!error && !editMode && !passwordError && usuario.id && !loading">
    Cambios guardados con éxito
  </div>
  <div class="alert alert-danger mt-3" *ngIf="error">{{ error }}</div>
</div>
